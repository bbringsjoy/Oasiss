CREATE TABLE categoria (
  id INT(11) NOT NULL AUTO_INCREMENT,
  nome VARCHAR(50) NOT NULL,
  ativo ENUM('S','N') NOT NULL DEFAULT 'S',
  PRIMARY KEY (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

INSERT INTO categoria (nome, ativo) VALUES
('Brownies', 'S'),
('Bolos', 'S'),
('Cookies', 'S');


CREATE TABLE usuario (
  id INT(11) NOT NULL AUTO_INCREMENT,
  nome VARCHAR(100) NOT NULL,
  email VARCHAR(100) NOT NULL UNIQUE,
  senha VARCHAR(255) NOT NULL,
  ativo ENUM('S','N') NOT NULL DEFAULT 'S',
  PRIMARY KEY (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

INSERT INTO usuario (nome, email, senha, ativo) VALUES
('Administrador DoceMix', 'admin@docemix.com', '$2y$10$ExemploSenhaHash', 'S');


-- TABELA DE PRODUTOS (DOCE)
CREATE TABLE doce (
  id INT(11) NOT NULL AUTO_INCREMENT,
  nome VARCHAR(100) NOT NULL,
  categoria_id INT(11) NOT NULL,
  descricao TEXT,
  valor DECIMAL(10,2) NOT NULL,
  imagem VARCHAR(255),
  ativo ENUM('S','N') NOT NULL DEFAULT 'S',
  PRIMARY KEY (id),
  KEY (categoria_id),
  CONSTRAINT fk_doce_categoria FOREIGN KEY (categoria_id)
    REFERENCES categoria(id)
    ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


CREATE TABLE cliente (
  id INT(11) NOT NULL AUTO_INCREMENT,
  nome VARCHAR(100) NOT NULL,
  email VARCHAR(100) NOT NULL UNIQUE,
  senha VARCHAR(255) NOT NULL,
  telefone VARCHAR(20),
  ativo ENUM('S','N') NOT NULL DEFAULT 'S',
  PRIMARY KEY (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


CREATE TABLE venda (
  id INT(11) NOT NULL AUTO_INCREMENT,
  cliente_id INT(11) NOT NULL,
  data DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  status ENUM('pendente', 'pago', 'entregue', 'cancelado') DEFAULT 'pendente',
  PRIMARY KEY (id),
  KEY (cliente_id),
  CONSTRAINT fk_venda_cliente FOREIGN KEY (cliente_id)
    REFERENCES cliente(id)
    ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


-- TABELA DE ITENS DA VENDA
CREATE TABLE item (
  venda_id INT(11) NOT NULL,
  produto_id INT(11) NOT NULL,
  qtde INT(11) NOT NULL,
  valor DECIMAL(10,2) NOT NULL,
  PRIMARY KEY (venda_id, produto_id),
  CONSTRAINT fk_item_venda FOREIGN KEY (venda_id)
    REFERENCES venda(id)
    ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT fk_item_produto FOREIGN KEY (produto_id)
    REFERENCES doce(id)
    ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


-- AUDITORIA
CREATE TABLE auditoria_preco (
  id INT AUTO_INCREMENT PRIMARY KEY,
  produto_id INT NOT NULL,
  valor_antigo DECIMAL(10,2) NOT NULL,
  valor_novo DECIMAL(10,2) NOT NULL,
  data_alteracao DATETIME DEFAULT CURRENT_TIMESTAMP,
  usuario_responsavel VARCHAR(100),
  FOREIGN KEY (produto_id) REFERENCES doce(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


-- TRIGGER

CREATE TRIGGER trg_auditoria_preco
BEFORE UPDATE ON doce
FOR EACH ROW
BEGIN
  IF NEW.valor <> OLD.valor THEN
    INSERT INTO auditoria_preco (produto_id, valor_antigo, valor_novo, usuario_responsavel)
    VALUES (OLD.id, OLD.valor, NEW.valor, CURRENT_USER());
  END IF;
END;


-- ÍNDICES
CREATE INDEX idx_doce_nome ON doce (nome);
CREATE INDEX idx_doce_categoria ON doce (categoria_id);
CREATE INDEX idx_cliente_email ON cliente (email);
CREATE INDEX idx_venda_cliente ON venda (cliente_id);
CREATE INDEX idx_venda_status ON venda (status);
CREATE INDEX idx_doce_ativo ON doce (ativo);
CREATE INDEX idx_cliente_ativo ON cliente (ativo);


-- FUNÇÃO DE DISPONIBILIDADE

CREATE FUNCTION verificar_disponibilidade_produto(produtoID INT)
RETURNS TINYINT
DETERMINISTIC
BEGIN
    DECLARE disponivel TINYINT DEFAULT 0;

    SELECT 
        CASE 
            WHEN ativo = 'S' THEN 1
            ELSE 0
        END
    INTO disponivel
    FROM doce
    WHERE id = produtoID;

    RETURN disponivel;
END;

