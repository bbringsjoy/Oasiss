create database oasiss;

CREATE TABLE usuarios (
    id_usuarios INT PRIMARY KEY AUTO_INCREMENT,
    email VARCHAR(255) NOT NULL,
    senha VARCHAR(255) NOT NULL,
    nome_completo VARCHAR(255),
    tipo_perfil ENUM('hospede', 'locador') NOT NULL,
    data_cadastro DATE
);

CREATE TABLE locadores (
    id_locadores INT PRIMARY KEY AUTO_INCREMENT,
    cpf VARCHAR(20),
    usuario_id INT,
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id_usuarios)
);

CREATE TABLE imoveis (
    id_imoveis INT PRIMARY KEY AUTO_INCREMENT,
    titulo VARCHAR(255),
    descricao TEXT,
    endereco_completo VARCHAR(255),
    cidade VARCHAR(100),
    preco_diario DECIMAL(10,2),
    nm_quartos INT,
    nm_banheiros INT,
    max_hospedes INT,
    nome_foto VARCHAR(255),
    comodidades TEXT,
    locador_id INT,
    FOREIGN KEY (locador_id) REFERENCES locadores(id_locadores)
);

CREATE TABLE reservas (
    id_reservas INT PRIMARY KEY AUTO_INCREMENT,
    data_checkin DATE,
    data_checkout DATE,
    valor_total DECIMAL(10,2),
    status_reserva VARCHAR(50),
    imovel_id INT,
    id_hospede INT,
    FOREIGN KEY (imovel_id) REFERENCES imoveis(id_imoveis),
    FOREIGN KEY (id_hospede) REFERENCES usuarios(id_usuarios)
);

CREATE TABLE avaliacoes (
    id_avaliacoes INT PRIMARY KEY AUTO_INCREMENT,
    nota INT,
    comentario TEXT,
    data_avaliacao DATE,
    imovel_id INT,
    hospede_id INT,
    FOREIGN KEY (imovel_id) REFERENCES imoveis(id_imoveis),
    FOREIGN KEY (hospede_id) REFERENCES usuarios(id_usuarios)
);

CREATE TABLE auditoria_precos_imoveis (
    id_auditoria INT AUTO_INCREMENT PRIMARY KEY,
    id_imovel INT NOT NULL,
    preco_antigo DECIMAL(10,2),
    preco_novo DECIMAL(10,2),
    data_alteracao DATETIME,
    usuario_id INT,
    acao VARCHAR(50),
    FOREIGN KEY (id_imovel) REFERENCES imoveis(id_imoveis),
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id_usuarios)
);

CREATE TABLE categoria_imovel (
    id_categoria INT AUTO_INCREMENT PRIMARY KEY,
    imovel_id INT NOT NULL,
    categoria ENUM('apartamento', 'casa') NOT NULL,
    FOREIGN KEY (imovel_id) REFERENCES imoveis(id_imoveis)
);

CREATE TRIGGER trg_auditoria_preco_imovel
AFTER UPDATE ON imoveis
FOR EACH ROW
BEGIN
    -- Verifica se o preço diário foi alterado
    IF OLD.preco_diario <> NEW.preco_diario THEN
        INSERT INTO auditoria_precos_imoveis (
            id_imovel,
            preco_antigo,
            preco_novo,
            data_alteracao,
            usuario_id,
            acao
        )
        VALUES (
            OLD.id_imoveis,
            OLD.preco_diario,
            NEW.preco_diario,
            NOW(),
            NEW.locador_id,
            'ALTERAÇÃO DE PREÇO'
        );
    END IF;
END ; 

CREATE PROCEDURE inserir_imoveis_padrao(IN p_locador_id INT)
BEGIN
    INSERT INTO imoveis (
        titulo, 
        descricao, 
        endereco_completo, 
        cidade, 
        preco_diario, 
        nm_quartos, 
        nm_banheiros, 
        max_hospedes, 
        nome_foto, 
        comodidades, 
        locador_id
    )
    VALUES
        ('Casa de Praia', 'Casa ampla com vista para o mar', 'Rua das Ondas, 100', 'Florianópolis', 350.00, 3, 2, 8, 'praia.jpg', 'Wi-Fi, Piscina, Ar-condicionado', p_locador_id),
        ('Apartamento Central', 'Apartamento moderno no centro da cidade', 'Av. Principal, 500', 'São Paulo', 280.00, 2, 1, 5, 'apto.jpg', 'Wi-Fi, Garagem', p_locador_id),
        ('Chalé da Serra', 'Chalé aconchegante em meio à natureza', 'Estrada da Serra, km 12', 'Gramado', 400.00, 2, 1, 4, 'chale.jpg', 'Lareira, Varanda, Estacionamento', p_locador_id),
        ('Cabana do Lago', 'Cabana com acesso direto ao lago', 'Rodovia do Lago, 250', 'Capitólio', 500.00, 2, 1, 6, 'cabana.jpg', 'Cozinha, Wi-Fi, Vista para o lago', p_locador_id);
END ;

-- Chamada da procedure (exemplo)
-- CALL inserir_imoveis_padrao(3);


-- Índices
CREATE UNIQUE INDEX idx_usuarios_email ON usuarios (email);
CREATE INDEX idx_usuarios_tipo_perfil ON usuarios (tipo_perfil);
CREATE INDEX idx_imoveis_cidade ON imoveis (cidade);
CREATE INDEX idx_imoveis_preco_diario ON imoveis (preco_diario);
CREATE INDEX idx_imoveis_locador ON imoveis (locador_id);



CREATE FUNCTION verificar_disponibilidade_imovel(
    p_id_imovel INT,
    p_data_checkin DATE,
    p_data_checkout DATE
)
RETURNS BOOLEAN
DETERMINISTIC
BEGIN
    DECLARE v_qtd_reservas INT;

    SELECT COUNT(*)
    INTO v_qtd_reservas
    FROM reservas
    WHERE imovel_id = p_id_imovel
      AND status_reserva <> 'cancelada'
      AND (
            (p_data_checkin BETWEEN data_checkin AND data_checkout)
         OR (p_data_checkout BETWEEN data_checkin AND data_checkout)
         OR (data_checkin BETWEEN p_data_checkin AND p_data_checkout)
         OR (data_checkout BETWEEN p_data_checkin AND p_data_checkout)
      );

    -- Se encontrou alguma reserva que se sobrepõe, não está disponível
    IF v_qtd_reservas > 0 THEN
        RETURN FALSE;
    ELSE
        RETURN TRUE;
    END IF;
END ;

